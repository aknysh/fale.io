box: wercker/default
build:
    steps:
        - arjen/hugo-build:
            version: 0.13
            config: config-it.yaml
        - arjen/hugo-build:
            version: 0.13
            config: config-en.yaml
        - script:
            name: create the static folder and populate it
            code: |
                mkdir public/static
                mv public/en/css public/static
                rm -rf public/it/css
                mv public/en/img public/static
                rm -rf public/it/img
                mv public/en/js public/static
                rm -rf public/it/js
                mv public/en/fonts public/static
                rm -rf public/it/fonts
        - script:
            name: compress with GZIP all objects
            code: |
                find public -iname '*.html' -exec gzip -9 -n {} \; -exec mv {}.gz {} \;
                find public -iname '*.css' -exec gzip -9 -n {} \; -exec mv {}.gz {} \;
                find public -iname '*.js' -exec gzip -9 -n {} \; -exec mv {}.gz {} \;

deploy:
    steps:
        - s3sync:
            key_id: $AWS_ACCESS_KEY_ID
            key_secret: $AWS_SECRET_ACCESS_KEY
            bucket_url: s3://fabiolocati.it
            source_dir: public/it/
            opts: --acl-public --encoding=gzip --add-encoding-exts=css,js,html
        - s3sync:
            key_id: $AWS_ACCESS_KEY_ID
            key_secret: $AWS_SECRET_ACCESS_KEY
            bucket_url: s3://fabiolocati.net
            source_dir: public/en/
            opts: "--acl-public --add-header='Content-Encoding: gzip'"
        - s3sync:
            key_id: $AWS_ACCESS_KEY_ID
            key_secret: $AWS_SECRET_ACCESS_KEY
            bucket_url: s3://static.fabiolocati.net
            source_dir: public/static/
            opts: "--acl-public --add-header='Content-Encoding: gzip'"
